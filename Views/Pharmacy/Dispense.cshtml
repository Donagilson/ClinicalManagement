@{
    ViewData["Title"] = "Dispense Medication";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-purple mb-0">
                        <i class="fas fa-capsules me-2"></i>Dispense Medication
                    </h2>
                    <p class="text-muted mb-0">Dispense medicines to patients</p>
                </div>
                <div>
                    <a asp-action="DispenseHistory" class="btn btn-outline-info me-2">
                        <i class="fas fa-history me-1"></i>History
                    </a>
                    <a asp-action="Index" class="btn btn-outline-purple">
                        <i class="fas fa-arrow-left me-1"></i>Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-purple">
                <div class="card-header bg-purple text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-capsules me-2"></i>Dispense Medicine
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="Dispense" method="post" id="dispenseForm">
                        @Html.AntiForgeryToken()

                        <div class="row g-3">
                            <div class="col-lg-6 col-md-12">
                                <label for="medicineSelect" class="form-label">Select Medicine *</label>
                                <select id="medicineSelect" name="MedicineId" class="form-select" required onchange="loadMedicineDetails()">
                                    <option value="">Choose a medicine...</option>
                                    @if (ViewBag.Medicines != null)
                                    {
                                        foreach (var medicine in ViewBag.Medicines)
                                        {
                                            <option value="@medicine.MedicineId" data-price="@medicine.UnitPrice" data-prescription="@medicine.RequiresPrescription.ToString()">
                                                @medicine.MedicineName (@medicine.MedicineCode)
                                            </option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="col-lg-6 col-md-12">
                                <label for="patientId" class="form-label">Patient ID *</label>
                                <input type="number" id="patientId" name="PatientId" class="form-control" placeholder="Enter patient ID" required />
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-3">
                                <label for="quantity" class="form-label">Quantity *</label>
                                <input type="number" id="quantity" name="Quantity" class="form-control" min="1" placeholder="0" required />
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Unit Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" id="unitPrice" name="UnitPrice" class="form-control" step="0.01" readonly />
                                </div>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Total Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" id="totalAmount" class="form-control" step="0.01" readonly />
                                </div>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Payment Method</label>
                                <select name="PaymentMethod" class="form-select">
                                    <option value="Cash">Cash</option>
                                    <option value="Card">Card</option>
                                    <option value="Insurance">Insurance</option>
                                    <option value="Credit">Credit</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-lg-3 col-md-6">
                                <label for="dosage" class="form-label">Dosage *</label>
                                <select id="dosage" name="Dosage" class="form-select" required>
                                    <option value="">Select dosage...</option>
                                    <option value="1 tablet">1 tablet</option>
                                    <option value="2 tablets">2 tablets</option>
                                    <option value="1/2 tablet">1/2 tablet</option>
                                    <option value="1 capsule">1 capsule</option>
                                    <option value="2 capsules">2 capsules</option>
                                    <option value="5ml">5ml</option>
                                    <option value="10ml">10ml</option>
                                    <option value="15ml">15ml</option>
                                    <option value="1 teaspoon">1 teaspoon</option>
                                    <option value="2 teaspoons">2 teaspoons</option>
                                    <option value="1 drop">1 drop</option>
                                    <option value="2 drops">2 drops</option>
                                    <option value="1 unit">1 unit</option>
                                    <option value="5 units">5 units</option>
                                    <option value="10 units">10 units</option>
                                    <option value="As directed">As directed</option>
                                </select>
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <label for="frequency" class="form-label">Frequency *</label>
                                <select id="frequency" name="Frequency" class="form-select" required>
                                    <option value="">Select frequency...</option>
                                    <option value="Once daily">Once daily</option>
                                    <option value="Twice daily">Twice daily</option>
                                    <option value="Thrice daily">Thrice daily</option>
                                    <option value="Four times daily">Four times daily</option>
                                    <option value="Every 6 hours">Every 6 hours</option>
                                    <option value="Every 8 hours">Every 8 hours</option>
                                    <option value="Every 12 hours">Every 12 hours</option>
                                    <option value="Once weekly">Once weekly</option>
                                    <option value="Twice weekly">Twice weekly</option>
                                    <option value="Once monthly">Once monthly</option>
                                    <option value="As needed">As needed (PRN)</option>
                                    <option value="Before meals">Before meals</option>
                                    <option value="After meals">After meals</option>
                                    <option value="At bedtime">At bedtime</option>
                                    <option value="Morning">Morning</option>
                                    <option value="Evening">Evening</option>
                                    <option value="Night">Night</option>
                                </select>
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <label for="duration" class="form-label">Duration *</label>
                                <select id="duration" name="Duration" class="form-select" required>
                                    <option value="">Select duration...</option>
                                    <option value="1 day">1 day</option>
                                    <option value="2 days">2 days</option>
                                    <option value="3 days">3 days</option>
                                    <option value="5 days">5 days</option>
                                    <option value="7 days">7 days</option>
                                    <option value="10 days">10 days</option>
                                    <option value="14 days">14 days</option>
                                    <option value="21 days">21 days</option>
                                    <option value="30 days">30 days</option>
                                    <option value="45 days">45 days</option>
                                    <option value="60 days">60 days</option>
                                    <option value="90 days">90 days</option>
                                    <option value="1 week">1 week</option>
                                    <option value="2 weeks">2 weeks</option>
                                    <option value="3 weeks">3 weeks</option>
                                    <option value="1 month">1 month</option>
                                    <option value="2 months">2 months</option>
                                    <option value="3 months">3 months</option>
                                    <option value="6 months">6 months</option>
                                    <option value="1 year">1 year</option>
                                    <option value="Until finished">Until finished</option>
                                    <option value="As directed">As directed</option>
                                </select>
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <label class="form-label">Payment Method</label>
                                <select name="PaymentMethod" class="form-select">
                                    <option value="Cash">Cash</option>
                                    <option value="Card">Card</option>
                                    <option value="Insurance">Insurance</option>
                                    <option value="Credit">Credit</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-lg-6 col-md-12">
                                <label for="instructions" class="form-label">Instructions</label>
                                <textarea id="instructions" name="Instructions" class="form-control" rows="2" placeholder="Enter usage instructions"></textarea>
                            </div>

                            <div class="col-lg-6 col-md-12">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea id="notes" name="Notes" class="form-control" rows="2" placeholder="Additional notes"></textarea>
                            </div>
                        </div>

                        <!-- Medicine Details Display -->
                        <div id="medicineDetails" class="alert alert-info mt-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Available Stock:</strong> <span id="availableStock">0</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Prescription Required:</strong> <span id="prescriptionRequired">No</span>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="button" class="btn btn-outline-secondary me-md-2" onclick="clearForm()">
                                <i class="fas fa-trash me-1"></i>Clear Form
                            </button>
                            <button type="submit" class="btn btn-purple" id="dispenseBtn">
                                <i class="fas fa-capsules me-1"></i>Dispense Medicine
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.text-purple {
    color: #7b68ee !important;
}

.bg-purple {
    background-color: #7b68ee !important;
}

.border-purple {
    border-color: #7b68ee !important;
}

.btn-purple {
    background-color: #7b68ee;
    border-color: #7b68ee;
    color: white;
}

.btn-purple:hover {
    background-color: #6a5acd;
    border-color: #6a5acd;
    color: white;
}

.btn-outline-purple {
    color: #7b68ee;
    border-color: #7b68ee;
}

.btn-outline-purple:hover {
    background-color: #7b68ee;
    border-color: #7b68ee;
    color: white;
}

.card {
    border-radius: 10px;
}

.form-control:focus,
.form-select:focus {
    border-color: #7b68ee;
    box-shadow: 0 0 0 0.2rem rgba(123, 104, 238, 0.25);
}

#dispenseBtn:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
}
</style>

<script>
let selectedMedicineData = null;

function loadMedicineDetails() {
    const medicineSelect = document.getElementById('medicineSelect');
    const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];

    if (selectedOption.value) {
        selectedMedicineData = {
            medicineId: selectedOption.value,
            unitPrice: parseFloat(selectedOption.getAttribute('data-price')),
            requiresPrescription: selectedOption.getAttribute('data-prescription') === 'True'
        };

        document.getElementById('unitPrice').value = selectedMedicineData.unitPrice.toFixed(2);
        document.getElementById('prescriptionRequired').textContent = selectedMedicineData.requiresPrescription ? 'Yes' : 'No';

        // Show medicine details
        document.getElementById('medicineDetails').style.display = 'block';
        document.getElementById('availableStock').textContent = 'Loading...';

        // In a real implementation, this would make an AJAX call to get current stock
        document.getElementById('availableStock').textContent = '100'; // Placeholder

        calculateTotal();
        validateForm();
    } else {
        document.getElementById('medicineDetails').style.display = 'none';
        selectedMedicineData = null;
        validateForm();
    }
}

function calculateTotal() {
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const unitPrice = selectedMedicineData ? selectedMedicineData.unitPrice : 0;
    const total = quantity * unitPrice;

    document.getElementById('totalAmount').value = total.toFixed(2);
    validateForm();
}

function validateForm() {
    const dispenseBtn = document.getElementById('dispenseBtn');
    const isValid = selectedMedicineData &&
                   document.getElementById('patientId').value &&
                   document.getElementById('quantity').value > 0 &&
                   document.getElementById('dosage').value &&
                   document.getElementById('frequency').value &&
                   document.getElementById('duration').value;

    dispenseBtn.disabled = !isValid;

    if (!isValid && selectedMedicineData) {
        dispenseBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Complete All Fields';
    } else if (selectedMedicineData) {
        dispenseBtn.innerHTML = '<i class="fas fa-capsules me-1"></i>Dispense Medicine';
    } else {
        dispenseBtn.innerHTML = '<i class="fas fa-capsules me-1"></i>Select Medicine';
    }
}

function clearForm() {
    document.getElementById('dispenseForm').reset();
    document.getElementById('medicineDetails').style.display = 'none';
    selectedMedicineData = null;
    validateForm();
}

// Event listeners
document.getElementById('quantity').addEventListener('input', calculateTotal);
document.getElementById('patientId').addEventListener('input', validateForm);
document.getElementById('medicineSelect').addEventListener('change', loadMedicineDetails);
document.getElementById('dosage').addEventListener('change', validateForm);
document.getElementById('frequency').addEventListener('change', validateForm);
document.getElementById('duration').addEventListener('change', validateForm);

// Initialize validation
document.addEventListener('DOMContentLoaded', function() {
    validateForm();
});
</script>
