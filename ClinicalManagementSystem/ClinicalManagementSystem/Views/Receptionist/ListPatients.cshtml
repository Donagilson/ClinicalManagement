@model IEnumerable<ClinicalManagementSystem2025.Models.Patient>
@{
    ViewData["Title"] = "Patient List";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-olive">
            <i class="fas fa-users me-2"></i>Patient List
        </h1>
        <div>
            <a asp-action="AddPatient" class="btn btn-olive me-2">
                <i class="fas fa-user-plus me-1"></i>Add New Patient
            </a>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Success / Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Search Section -->
    <div class="card shadow-sm border-olive mb-4">
        <div class="card-header bg-olive text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-search me-2"></i>Search Patients
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchTerm" placeholder="Enter Patient ID or Phone Number">
                        <button class="btn btn-olive" type="button" id="btnSearch">
                            <i class="fas fa-search me-1"></i>Search
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="btnClearSearch">
                            <i class="fas fa-times me-1"></i>Clear
                        </button>
                    </div>
                    <small class="text-muted">Search by Patient ID or Phone Number. Multiple patients with same phone will be shown.</small>
                </div>
            </div>

            <!-- Search Results Section -->
            <div id="searchResults" class="mt-3" style="display: none;">
                <h6 class="text-olive">Search Results:</h6>
                <div id="searchResultsContent">
                    <!-- Search results will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Patients Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-olive text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>All Patients
            </h5>
            <span class="badge bg-light text-olive" id="patientCount">@Model.Count() patients</span>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="patientsTable">
                        <thead class="bg-light text-olive">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Gender</th>
                                <th>Age</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var patient in Model.OrderByDescending(p => p.RegistrationDate))
                            {
                                <tr>
                                    <td>
                                        <span class="badge bg-olive">@patient.PatientId</span>
                                    </td>
                                    <td>
                                        <strong>@patient.FullName</strong>
                                    </td>
                                    <td>
                                        <i class="fas fa-phone me-1 text-muted"></i>@patient.Phone
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(patient.Email))
                                        {
                                            <i class="fas fa-envelope me-1 text-muted"></i>@patient.Email
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @(patient.Gender == "Male" ? "bg-info" : patient.Gender == "Female" ? "bg-warning" : "bg-secondary")">
                                            @patient.Gender
                                        </span>
                                    </td>
                                    <td>
                                        <span class="text-muted">@patient.Age years</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">@patient.RegistrationDate.ToString("MMM dd, yyyy")</small>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a asp-action="PatientDetails" asp-route-id="@patient.PatientId"
                                               class="btn btn-sm btn-outline-olive" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a asp-action="ScheduleAppointmentForPhone"
                                               asp-route-phone="@patient.Phone"
                                               asp-route-patientId="@patient.PatientId"
                                               class="btn btn-sm btn-olive" title="Schedule Appointment">
                                                <i class="fas fa-calendar-plus"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Patients Found</h5>
                    <p class="text-muted">No patients have been registered yet.</p>
                    <a asp-action="AddPatient" class="btn btn-olive">
                        <i class="fas fa-user-plus me-1"></i>Add First Patient
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Auto-hide success/error messages
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);

            // Search functionality
            $('#btnSearch').click(function() {
                performSearch();
            });

            // Allow Enter key to search
            $('#searchTerm').keypress(function(e) {
                if (e.which == 13) {
                    performSearch();
                }
            });

            // Clear search functionality
            $('#btnClearSearch').click(function() {
                $('#searchTerm').val('');
                $('#searchResults').hide();
                $('#patientsTable tbody tr').show();
                updatePatientCount();
            });

            function performSearch() {
                var searchTerm = $('#searchTerm').val().trim();

                if (!searchTerm) {
                    alert('Please enter a Patient ID or Phone Number to search');
                    return;
                }

                // Show loading
                $('#searchResultsContent').html('<div class="text-center"><div class="spinner-border text-olive" role="status"></div><p>Searching...</p></div>');
                $('#searchResults').show();

                // Call the search API
                $.post('@Url.Action("SearchPatientByIdOrPhone", "Receptionist")', { searchTerm: searchTerm })
                    .done(function(response) {
                        if (response.success && response.patients.length > 0) {
                            displaySearchResults(response.patients);
                            filterMainTable(searchTerm);
                        } else {
                            $('#searchResultsContent').html('<div class="alert alert-warning">No patients found with ID or phone number: <strong>' + searchTerm + '</strong></div>');
                            $('#patientsTable tbody tr').hide();
                            updatePatientCount(0);
                        }
                    })
                    .fail(function() {
                        $('#searchResultsContent').html('<div class="alert alert-danger">Error occurred while searching. Please try again.</div>');
                    });
            }

            function displaySearchResults(patients) {
                var html = '';

                if (patients.length > 1) {
                    html += '<div class="alert alert-info"><i class="fas fa-info-circle me-1"></i><strong>' + patients.length + ' patients found</strong> (multiple patients with same phone number)</div>';
                }

                html += '<div class="row">';

                patients.forEach(function(patient) {
                    html += '<div class="col-md-6 mb-3">';
                    html += '    <div class="card border-olive">';
                    html += '        <div class="card-body">';
                    html += '            <h6 class="card-title text-olive">';
                    html += '                <i class="fas fa-user me-1"></i>' + patient.fullName;
                    html += '                <span class="badge bg-olive ms-2">ID: ' + patient.patientId + '</span>';
                    html += '            </h6>';
                    html += '            <p class="mb-1"><i class="fas fa-phone me-1 text-muted"></i>Phone: ' + patient.phone + '</p>';
                    html += '            <p class="mb-1"><i class="fas fa-envelope me-1 text-muted"></i>Email: ' + patient.email + '</p>';
                    html += '            <p class="mb-1">Gender: <span class="badge bg-info">' + patient.gender + '</span> | Age: ' + patient.age + ' years</p>';
                    html += '            <small class="text-muted">Registered: ' + patient.registrationDate + '</small>';
                    html += '            <div class="mt-3">';
                    html += '                <a href="/Receptionist/PatientDetails/' + patient.patientId + '" class="btn btn-sm btn-outline-olive me-1">';
                    html += '                    <i class="fas fa-eye me-1"></i>View Details';
                    html += '                </a>';
                    html += '                <a href="/Receptionist/ScheduleAppointmentForPhone?phone=' + encodeURIComponent(patient.phone) + '&patientId=' + patient.patientId + '" class="btn btn-sm btn-olive">';
                    html += '                    <i class="fas fa-calendar-plus me-1"></i>Schedule';
                    html += '                </a>';
                    html += '            </div>';
                    html += '        </div>';
                    html += '    </div>';
                    html += '</div>';
                });

                html += '</div>';
                $('#searchResultsContent').html(html);
            }

            function filterMainTable(searchTerm) {
                var visibleCount = 0;
                $('#patientsTable tbody tr').each(function() {
                    var row = $(this);
                    var patientId = row.find('td:first .badge').text();
                    var phone = row.find('td:nth-child(3)').text().replace(/\s/g, '');

                    if (patientId.includes(searchTerm) || phone.includes(searchTerm)) {
                        row.show();
                        visibleCount++;
                    } else {
                        row.hide();
                    }
                });
                updatePatientCount(visibleCount);
            }

            function updatePatientCount(count) {
                if (count === undefined) {
                    count = $('#patientsTable tbody tr:visible').length;
                }
                var totalCount = @Model.Count();
                $('#patientCount').text(count + ' patient' + (count !== 1 ? 's' : '') + (count < totalCount ? ' (filtered)' : ''));
            }
        });
    </script>
}
